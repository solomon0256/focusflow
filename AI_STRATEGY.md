
# FocusFlow AI 专注度检测技术方案 (Technical Specification) V2

## 1. 核心架构：全平台统一 WASM (Cross-Platform Architecture)
*   **技术栈**: MediaPipe Tasks Vision (WebAssembly 版本).
*   **兼容性确认**:
    *   **iOS (Safari/WebView)**: 支持。依赖 WebGL 后端。
    *   **Android (Chrome/WebView)**: 支持。依赖 WebGL 后端。
    *   **PC Web**: 支持。
*   **加载机制**: 
    1.  App 启动时下载 `.wasm` (二进制引擎) 和 `.task` (模型权重) 到本地缓存。
    2.  初始化 `FilesetResolver` 和 `PoseLandmarker`。
    3.  **内存驻留**: 初始化完成后，模型常驻内存，后续检测无网络请求，零延迟。
*   **选定模型**: **`PoseLandmarker (Lite)`**
    *   *原因*: 这是一个“全能”模型。它不仅提供身体骨架（肩膀、手臂），还内置了面部网格（Face Mesh）。相比于同时运行 Face 和 Pose 两个模型，运行这一个模型的性能开销减半，且完全满足需求。

---

## 2. 场景定义：宽松的桌面模式 (Lenient Desk Mode)

**不做军训式的监控**。我们的目标是捕捉“明显的走神”和“长时间的疲劳”，容忍正常的生理活动（喝水、伸懒腰、短暂转头）。

### 2.1 核心检测因子与宽松阈值 (Thresholds)

我们采用 **“基准值 + 偏差区间”** 的算法，而不是写死的绝对角度。
*在用户点击“开始专注”的前 3 秒，我们会记录他的姿态作为 `Base_Pose`。*

| 维度 | 检测指标 | 宽松阈值 (Tolerance) | 判定逻辑 |
| :--- | :--- | :--- | :--- |
| **A. 头部姿态** | Pitch (低头/抬头) | **± 45°** (非常宽) | 允许大幅度低头写字或抬头看屏幕。只有完全趴下或仰头睡觉才触发。 |
| **B. 头部转向** | Yaw (左右转头) | **± 40°** | 允许查阅侧面资料。只有完全扭头看别处才触发。 |
| **C. 身体稳定性** | MMI (微动指数) | **High Variance** | 只有**剧烈**的持续晃动（如离开座位走动）或**死一样的静止**（判定为心流）才有意义。普通抖腿忽略。 |
| **D. 肩部水平** | Roll (歪头杀) | **± 25°** | 允许稍微歪头思考。 |
| **E. 疲劳检测** | 闭眼时长 | **> 1.5 秒** | 正常眨眼(0.2s)忽略。只有明显的闭目养神才计入疲劳。 |

### 2.2 时间缓冲机制 (Time Buffer / Hysteresis)

为了消除误报，我们引入 **5秒滑动窗口 (Sliding Window)**。

*   **瞬时状态**: AI 每秒检测 10-15 次。
*   **判定状态**: 
    *   如果 AI 检测到 `Distracted`，**不立即报警**。
    *   只有当 `Distracted` 状态在过去 5 秒内占比超过 **80%** 时，才正式切换 App 状态为“分心”。
    *   *效果*: 你转头拿杯咖啡（2秒），AI 内部会标记为分心，但 App 界面保持“专注”，不会打断你。你玩手机超过 5 秒，App 界面变红。

---

## 3. 四级专注状态机 (The 4-Level State Machine)

基于 `PoseLandmarker` 的 33 个骨架点 + 面部特征。

#### **Level 4: 心流 (Deep Flow)**
*   **特征**: “雕塑般的静止”。
*   **判定**: 
    1.  `Face` 在正中区域 (Yaw < 15°)。
    2.  `Shoulders` 极其稳定 (位移方差 < 0.002)。
    3.  `Blink Rate` 低于 10次/分 (可选，视光线而定)。
*   **反馈**: 界面显示绿色呼吸光环。

#### **Level 3: 专注 (Focused) - 默认状态**
*   **特征**: 正常的学习姿态。
*   **判定**: 
    1.  检测到人脸。
    2.  姿态在允许的宽松阈值内 (Pitch < 45°, Yaw < 40°)。
    3.  有正常的微小活动。
*   **反馈**: 界面显示绿色静态圆环。

#### **Level 2: 疲劳/游离 (Wandering)**
*   **特征**: 姿态崩坏或闭眼。
*   **判定**: 
    1.  `Spine Angle` (脊柱倾角) 严重后仰或前趴 (偏离基准 > 30%)。
    2.  或者：检测到闭眼 > 1.5秒。
*   **反馈**: 界面变黄，提示“Rest your eyes?”。

#### **Level 1: 分心 (Distracted)**
*   **特征**: 人不在或完全背对屏幕。
*   **判定**: 
    1.  `Pose Visibility` < 0.5 (人走丢了)。
    2.  或者：`Yaw` > 50° (持续 5 秒以上)。
    3.  或者：`Hand` 举起在脸前持续不动 (高概率在玩手机/打电话)。
*   **反馈**: 界面变红，暂停计时（可选）。

---

## 4. 实现路线图 (Implementation Plan)

1.  **资源准备**: 
    *   下载 `pose_landmarker_lite.task` (约 8MB) 放入项目。
    *   下载 `wasm` 文件。
2.  **代码替换**: 
    *   修改 `FocusSessionView.tsx`。
    *   从 `FaceLandmarker` 切换为 `PoseLandmarker`。
    *   实现 `Calibration` (校准) 阶段：倒计时 3..2..1 时读取用户姿态作为 (0,0,0) 基准点。
3.  **数据平滑**: 
    *   实现简单的 `SmoothingFilter`，避免数值跳变。
